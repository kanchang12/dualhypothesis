<!DOCTYPE html>
<html>
<head>
    <title>Cost Comparison - 50 Automated Tests</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; margin: 0; }
        h1 { text-align: center; margin-bottom: 10px; }
        
        /* Progress dots */
        .progress-bar { 
            text-align: center; 
            padding: 20px; 
            background: white; 
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dots { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center;
            margin-top: 15px;
        }
        .dot { 
            width: 14px; 
            height: 14px; 
            border-radius: 50%; 
            background: #ddd;
            transition: all 0.3s;
        }
        .dot.success { background: #4CAF50; }
        .dot.fail { background: #f44336; }
        
        /* Start button */
        .start-btn {
            background: #2196F3;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(33,150,243,0.3);
        }
        .start-btn:hover { background: #1976D2; }
        .start-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Results container */
        .container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
        }
        .panel { 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h2 { 
            margin-top: 0; 
            padding-bottom: 10px;
            border-bottom: 3px solid #ddd;
        }
        .panel.gemini h2 { color: #4285f4; border-color: #4285f4; }
        .panel.dual h2 { color: #ea4335; border-color: #ea4335; }
        
        /* KPIs */
        .kpis { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 6px;
            margin: 15px 0;
        }
        .kpi-row { 
            display: flex; 
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        .kpi-label { color: #666; }
        .kpi-value { font-weight: bold; color: #333; }
        
        /* Current test */
        .current-test {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            color: #1976d2;
        }
        
        /* Status */
        .status {
            text-align: center;
            padding: 15px;
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Automated Cost Comparison: Gemini vs Gemini+OpenAI</h1>
    
    <div class="progress-bar">
        <button class="start-btn" id="startBtn" onclick="runAllTests()">
            Start 50 Tests
        </button>
        <div class="dots" id="dots"></div>
    </div>
    
    <div class="container">
        <div class="panel gemini">
            <h2>Path 1: Gemini Only</h2>
            <div id="gemini-status" class="status">Ready to start</div>
            <div id="gemini-current" class="current-test" style="display:none;"></div>
            <div class="kpis">
                <div class="kpi-row">
                    <span class="kpi-label">Tests Completed:</span>
                    <span class="kpi-value" id="gemini-count">0 / 50</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Time:</span>
                    <span class="kpi-value" id="gemini-time">0s</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Tokens:</span>
                    <span class="kpi-value" id="gemini-tokens">0</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Cost:</span>
                    <span class="kpi-value" id="gemini-cost">$0.000000</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Attempts:</span>
                    <span class="kpi-value" id="gemini-attempts">0</span>
                </div>
            </div>
        </div>
        
        <div class="panel dual">
            <h2>Path 2: Gemini + OpenAI</h2>
            <div id="dual-status" class="status">Ready to start</div>
            <div id="dual-current" class="current-test" style="display:none;"></div>
            <div class="kpis">
                <div class="kpi-row">
                    <span class="kpi-label">Tests Completed:</span>
                    <span class="kpi-value" id="dual-count">0 / 50</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Time:</span>
                    <span class="kpi-value" id="dual-time">0s</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Tokens:</span>
                    <span class="kpi-value" id="dual-tokens">0</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Cost:</span>
                    <span class="kpi-value" id="dual-cost">$0.000000</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Validation Pass:</span>
                    <span class="kpi-value" id="dual-pass">0</span>
                </div>
                <div class="kpi-row">
                    <span class="kpi-label">Total Attempts:</span>
                    <span class="kpi-value" id="dual-attempts">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let prompts = [];
        let currentTest = 0;
        let testsCompleted = 0;
        let geminiTotal = { count: 0, time: 0, tokens: 0, cost: 0 };
        let dualTotal = { count: 0, time: 0, tokens: 0, cost: 0, pass: 0 };
        
        // Load prompts and create dots on page load
        fetch('/api/prompts')
            .then(r => r.json())
            .then(data => {
                prompts = data.prompts;
                createDots();
            });
        
        function createDots() {
            const dotsContainer = document.getElementById('dots');
            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.id = 'dot-' + i;
                dotsContainer.appendChild(dot);
            }
        }
        
        async function runAllTests() {
            document.getElementById('startBtn').disabled = true;
            currentTest = 0;
            testsCompleted = 0;
            geminiTotal = { count: 0, time: 0, tokens: 0, cost: 0 };
            dualTotal = { count: 0, time: 0, tokens: 0, cost: 0, pass: 0 };
            
            document.getElementById('gemini-status').textContent = 'Running...';
            document.getElementById('dual-status').textContent = 'Running...';
            
            for (let i = 0; i < prompts.length; i++) {
                currentTest = i;
                await runSingleTest(prompts[i], i);
                await sleep(1000); // 1 second delay between tests
            }
            
            document.getElementById('gemini-status').textContent = 'Complete!';
            document.getElementById('dual-status').textContent = 'Complete!';
            document.getElementById('startBtn').disabled = false;
        }
        
        async function runSingleTest(prompt, index) {
            // Show current test
            document.getElementById('gemini-current').style.display = 'block';
            document.getElementById('gemini-current').textContent = `Test ${index + 1}: ${prompt.substring(0, 50)}...`;
            document.getElementById('dual-current').style.display = 'block';
            document.getElementById('dual-current').textContent = `Test ${index + 1}: ${prompt.substring(0, 50)}...`;
            
            let attempts = 0;
            let validationPassed = false;
            
            while (!validationPassed && attempts < 10) {  // Max 10 retries
                attempts++;
                
                try {
                    // Run both paths in parallel
                    const [geminiResult, dualResult] = await Promise.all([
                        fetch('/api/gemini', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({prompt})
                        }).then(r => r.json()),
                        
                        fetch('/api/dual', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({prompt})
                        }).then(r => r.json())
                    ]);
                    
                    // Update gemini totals
                    geminiTotal.count++;
                    geminiTotal.time += geminiResult.time;
                    geminiTotal.tokens += geminiResult.gemini_in + geminiResult.gemini_out;
                    geminiTotal.cost += geminiResult.cost;
                    
                    // Update dual totals
                    dualTotal.count++;
                    dualTotal.time += dualResult.time;
                    dualTotal.tokens += dualResult.gemini_in + dualResult.gemini_out + dualResult.openai_in + dualResult.openai_out;
                    dualTotal.cost += dualResult.total_cost;
                    
                    // Check validation
                    try {
                        const validation = JSON.parse(dualResult.validation);
                        if (validation.valid) {
                            validationPassed = true;
                            dualTotal.pass++;
                            document.getElementById('dot-' + index).className = 'dot success';
                        } else {
                            // Failed validation - show red temporarily, will retry
                            document.getElementById('dot-' + index).className = 'dot fail';
                            document.getElementById('dual-current').textContent = `Test ${index + 1}: Retry ${attempts}... ${prompt.substring(0, 40)}...`;
                        }
                    } catch {
                        // Parse error - retry
                        document.getElementById('dot-' + index).className = 'dot fail';
                        document.getElementById('dual-current').textContent = `Test ${index + 1}: Retry ${attempts}... ${prompt.substring(0, 40)}...`;
                    }
                    
                    // Update displays
                    updateDisplay();
                    
                    // Small delay before retry
                    if (!validationPassed && attempts < 10) {
                        await sleep(500);
                    }
                    
                } catch (error) {
                    console.error('Test failed:', error);
                    // Still retry on error
                    await sleep(500);
                }
            }
            
            // If still failed after 10 attempts, mark as failed
            if (!validationPassed) {
                document.getElementById('dot-' + index).className = 'dot fail';
            }
            
            testsCompleted++;
            updateDisplay();
        }
        
        function updateDisplay() {
            // Gemini stats
            document.getElementById('gemini-count').textContent = `${testsCompleted} / 50`;
            document.getElementById('gemini-time').textContent = geminiTotal.time.toFixed(2) + 's';
            document.getElementById('gemini-tokens').textContent = geminiTotal.tokens;
            document.getElementById('gemini-cost').textContent = '$' + geminiTotal.cost.toFixed(6);
            document.getElementById('gemini-attempts').textContent = geminiTotal.count;
            
            // Dual stats
            document.getElementById('dual-count').textContent = `${testsCompleted} / 50`;
            document.getElementById('dual-time').textContent = dualTotal.time.toFixed(2) + 's';
            document.getElementById('dual-tokens').textContent = dualTotal.tokens;
            document.getElementById('dual-cost').textContent = '$' + dualTotal.cost.toFixed(6);
            document.getElementById('dual-pass').textContent = dualTotal.pass;
            document.getElementById('dual-attempts').textContent = dualTotal.count;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
